{"remainingRequest":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\src\\views\\yuedubook.vue?vue&type=style&index=0&lang=less&spcode=true&","dependencies":[{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\src\\views\\yuedubook.vue","mtime":1584701662000},{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\less-loader\\dist\\cjs.js","mtime":499162500000},{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"H:\\1962VUE-cil-router\\vueAPp\\fictionApp\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCg0KLmNhdGFsb2d1ZWppZW1pYW4gew0KICB3aWR0aDogODAlOw0KICBoZWlnaHQ6IDEwMCU7DQogIHBvc2l0aW9uOiBhYnNvbHV0ZTsNCiAgdG9wOiAwOw0KICBsZWZ0OiAtMTAwJTsNCiAgdHJhbnNpdGlvbjogYWxsIDAuM3MgZWFzZTsNCiAgJi5zaG93IHsNCiAgICBsZWZ0OiAwcHg7DQogIH0NCn0NCi5zaG93Q29udHJvbCB7DQogIC50b3Agew0KICAgIHRvcDogMDsNCiAgfQ0KICAuYm90dG9tIHsNCiAgICBib3R0b206IDA7DQogIH0NCn0NCg0KLnRvcCwNCi5ib3R0b20gew0KICB0cmFuc2l0aW9uOiBhbGwgMC4zcyBlYXNlOw0KfQ0KDQoudG9wIHsNCiAgd2lkdGg6IDEwMCU7DQogIHBvc2l0aW9uOiBmaXhlZDsNCiAgdG9wOiAtMTUwcHg7DQp9DQoNCi5ib3R0b20gew0KICB3aWR0aDogMTAwJTsNCiAgcG9zaXRpb246IGZpeGVkOw0KICBib3R0b206IC01MDBweDsNCn0NCg0KLnl1ZWR1Ym9vayB7DQogIHdpZHRoOiAxMDAlOw0KICBoZWlnaHQ6IDEwMCU7DQogIGJhY2tncm91bmQtY29sb3I6ICNlZWU2ZGQ7DQoNCiAgcGFkZGluZy10b3A6IDAuNjY2NjdyZW07DQogIHRleHQtYWxpZ246IGxlZnQ7DQoNCiAgJi5uaWdodCB7DQogICAgYmFja2dyb3VuZC1jb2xvcjogIzBjMGMwYzsNCiAgICBoMiB7DQogICAgICBjb2xvcjogIzg4ODsNCiAgICB9DQogICAgLnl1ZWR1Ym9vay1ib3ggew0KICAgICAgcCB7DQogICAgICAgIGNvbG9yOiAjNjY2Ow0KICAgICAgfQ0KICAgIH0NCiAgfQ0KDQogICYuZXllc2hpZWxkIHsNCiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjYjhjZDhkOw0KICAgIGgyIHsNCiAgICAgIGNvbG9yOiAjMGMyZTEwOw0KICAgIH0NCiAgICAueXVlZHVib29rLWJveCB7DQogICAgICBwIHsNCiAgICAgICAgY29sb3I6IHJnYmEoMTIsIDQ2LCAxNiwgMC44KTsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBoMiB7DQogICAgbWFyZ2luOiAwcHg7DQogICAgY29sb3I6ICMzMzM7DQogICAgcGFkZGluZzogMCAwLjUzMzMzcmVtOw0KICAgIGxpbmUtaGVpZ2h0OiAxLjU7DQoNCiAgICBmb250LXNpemU6IDI0cHg7DQogIH0NCg0KICAueXVlZHVib29rLWJveCB7DQogICAgY29sb3I6ICMzMzM7DQogICAgcGFkZGluZzogMC4yNjY2N3JlbSAwLjUzMzMzcmVtIDA7DQoNCiAgICBwIHsNCiAgICAgIGNvbG9yOiAjNWM1ZDU4Ow0KICAgICAgLy8gdGV4dC1pbmRlbnQ6IDJlbTsNCiAgICAgIHRleHQtaW5kZW50OiAxY207DQoNCiAgICAgIGxpbmUtaGVpZ2h0OiAxLjU7DQogICAgICBtYXJnaW46IDAuMzMzM3JlbSAwOw0KICAgIH0NCiAgfQ0KDQogIC5lcndlaW1hIHsNCiAgICB3aWR0aDogMTAwJTsNCiAgICBoZWlnaHQ6IDEwMHB4Ow0KICB9DQp9DQo="},{"version":3,"sources":["yuedubook.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA4RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA","file":"yuedubook.vue","sourceRoot":"src/views","sourcesContent":["<template>\r\n  <div :class=\"{showControl: control}\">\r\n    <van-loading size=\"24px\" vertical v-show=\"startloading\">加载中...</van-loading>\r\n    <div class=\"top\">\r\n      <yueduHead :title=\"info.title\" :id=\"$route.query.id\" />\r\n    </div>\r\n\r\n    <div class=\"yuedubook\" :class=\"classObj\" @click.stop=\"yuedubookClickFn\">\r\n      <van-list\r\n        :error.sync=\"error\"\r\n        error-text=\"请求失败，点击重新加载\"\r\n        v-model=\"loading\"\r\n        :finished=\"finished\"\r\n        finished-text=\"没有更多了\"\r\n        @load=\"onLoad\"\r\n      >\r\n        <van-cell v-for=\"(item, index) in list\" :key=\"index\">\r\n          <h2 :style=\"{fontSize: (fontSize+4)+'px'}\">{{item.title}}</h2>\r\n          <div class=\"yuedubook-box\">\r\n            <p\r\n              v-for=\"(content, index) in item.cpContent\"\r\n              :key=\"index\"\r\n              :style=\"{fontSize: fontSize+'px'}\"\r\n            >{{content}}</p>\r\n          </div>\r\n          <div class=\"erweima\"></div>\r\n        </van-cell>\r\n      </van-list>\r\n    </div>\r\n    <div class=\"bottom\">\r\n      <yuduFooter @setData=\"setData\" :index=\"page\" />\r\n    </div>\r\n    <div class=\"cataloguejiemian\" :class=\"{show: showCatalogue}\">\r\n      <yueduCatalogue\r\n        :chapters=\"zhangjielist\"\r\n        @setData=\"setData\"\r\n        :obj=\"{ title:info.title,\r\n                index: this.page,}\"\r\n      />\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport Vue from \"vue\";\r\nimport yueduHead from \"../components/yueduHead\";\r\nimport yuduFooter from \"../components/yueduFooter\";\r\nimport yueduCatalogue from \"../components/yueduCatalogue\";\r\nexport default {\r\n  data() {\r\n    return {\r\n      error: false,\r\n      info: {},\r\n      startloading: true,\r\n      zhangjielist: null,\r\n      // 章节数\r\n      index: 0,\r\n      // 数组索引\r\n      page: 0,\r\n      list: [],\r\n      loading: false,\r\n      finished: false,\r\n\r\n      control: false,\r\n      showCatalogue: false,\r\n      fontSize: 20,\r\n      classObj: {\r\n        default: true,\r\n        night: false,\r\n        eyeshield: false\r\n      }\r\n    };\r\n  },\r\n  components: {\r\n    yueduHead,\r\n    yuduFooter,\r\n    yueduCatalogue\r\n  },\r\n  methods: {\r\n    yuedubookClickFn() {\r\n      if (this.showCatalogue) {\r\n        this.showCatalogue = !this.showCatalogue;\r\n      } else {\r\n        this.control = !this.control;\r\n      }\r\n    },\r\n    setData({ key, value }) {\r\n      if (key === \"index\") {\r\n        window.console.log(\"index被更改\", value);\r\n        // page存在的意义 防止请求过后提前把index自增了，导致流向子组件的index流下去了两次，产生点击目录是先红被点击的前一章，然后在调整\r\n        switch (value) {\r\n          case \"--\":\r\n            this[key] -= 2;\r\n            this.page = this[key];\r\n            break;\r\n          case \"++\":\r\n            // this[key] = ++this[key];\r\n            this.page = this[key];\r\n            break;\r\n          default:\r\n            this[key] = value;\r\n            this.page = value;\r\n            break;\r\n        }\r\n        \r\n\r\n        this.list = [];\r\n        this.onLoad();\r\n      } else {\r\n        this[key] = value;\r\n      }\r\n    },\r\n    updatabookrack() {\r\n      // 获取本地数据\r\n      var bookrack = JSON.parse(localStorage.getItem(\"bookrack\"));\r\n      if (bookrack) {\r\n        window.console.log(\"存在\", bookrack);\r\n        // 存在\r\n        // 在判断本书是否被阅读过\r\n        let ischange = true;\r\n        // 已被阅读过就更新\r\n        for (let i = 0; i < bookrack.length; i++) {\r\n          if (bookrack[i].id === this.$route.query.id) {\r\n            window.console.log(\"已被阅读\");\r\n            // 找到了，让下面不用执行了\r\n            ischange = false;\r\n            bookrack[i].time = new Date();\r\n            bookrack[i].index = this.index;\r\n            bookrack.push(bookrack.splice(i, 1)[0]);\r\n\r\n            break;\r\n          }\r\n        }\r\n        // 没被阅读过就添加\r\n        if (ischange) {\r\n          window.console.log(\"从未阅读过\");\r\n          bookrack.push({\r\n            time: new Date(),\r\n            index: this.index,\r\n            id: this.$route.query.id,\r\n            title: this.info.title,\r\n            cover: window.unescape(this.info.cover).slice(7)\r\n          });\r\n        }\r\n      } else {\r\n        window.console.log(\"不存在，第一次创建阅读记录对象\");\r\n        // 不存在\r\n        bookrack = [\r\n          {\r\n            time: new Date(),\r\n            index: this.index,\r\n            id: this.$route.query.id,\r\n            title: this.info.title,\r\n            cover: window.unescape(this.info.cover).slice(7)\r\n          }\r\n        ];\r\n      }\r\n      window.console.log(bookrack);\r\n      // 保存到本地\r\n      localStorage.setItem(\"bookrack\", JSON.stringify(bookrack));\r\n    },\r\n    onLoad() {\r\n      // 这里会在路由进来后，渲染时执行一次，所以这里多了一次初始化数据\r\n      // 这里加判断是为了防止重复初始化数据，使用immediate-check，会导致v-for无法进行渲染\r\n      window.console.log(\"onLoad执行\");\r\n\r\n      Vue.axios(\r\n        \"http://novel.kele8.cn/chapters/\" +\r\n          this.formating(this.zhangjielist[this.index].link)\r\n      ).then(res => {\r\n        var obj = {\r\n          title: res.data.chapter.title,\r\n          cpContent: res.data.chapter.cpContent.split(\"\\n\")\r\n        };\r\n        // 添加到渲染列表\r\n        this.list.push(obj);\r\n        this.loading = false;\r\n\r\n        // 自增之后就是真正的章节数，没自增之前只是用来做数组下标\r\n        this.page = this.index++;\r\n\r\n        // 更新url，防止点去书架再点返回结果还是跳回最初进来时的章数\r\n        if (window.history) {\r\n          // 获取当前url\r\n          let url = window.location.href;\r\n          // 拼接当前页码\r\n          let str = url.slice(0, url.indexOf(\"index=\") + 5 + 1) + this.index;\r\n          // let nextStr = url.slice(url.indexOf(\"&id\"));\r\n          // 更改url\r\n          window.console.log(url);\r\n          window.console.log(str);\r\n          window.history.pushState(null, null, str);\r\n        }\r\n\r\n        this.updatabookrack();\r\n\r\n        // 如果阅读的书，也存在的书架里，那么书架的阅读记录也要更新\r\n        this.$store.commit(\"setBook\", {\r\n          id: this.$route.query.id,\r\n          value: this.index,\r\n          key: \"index\"\r\n        });\r\n      });\r\n    },\r\n    formating(str) {\r\n      // : / ? =\r\n      var arr = str.split(\"\");\r\n      for (var i = 0; i < arr.length; i++) {\r\n        if (arr[i] === \":\") {\r\n          arr[i] = \"%3A\";\r\n        }\r\n        if (arr[i] === \"/\") {\r\n          arr[i] = \"%2F\";\r\n        }\r\n        if (arr[i] === \"?\") {\r\n          arr[i] = \"%3F\";\r\n        }\r\n        if (arr[i] === \"=\") {\r\n          arr[i] = \"%3D\";\r\n        }\r\n      }\r\n      var newStr = arr.join(\"\");\r\n      return newStr;\r\n    }\r\n  },\r\n  beforeRouteEnter(to, from, next) {\r\n    window.console.log(\"beforeRouteEnter开始执行\");\r\n    // to和from都储存的是路由的$route对象\r\n    // to是指被访问的路由，也就是当前路由\r\n    // from指的是从哪个路由跳过来的，上一个路由\r\n\r\n    // 1.0 第一请求书源id\r\n    Vue.axios(\r\n      \"http://novel.kele8.cn/book-sources?view=summary&book=\" + to.query.id\r\n    )\r\n      .then(res => {\r\n        // 2.0 第二次请求章节列表，得到各个章节的link\r\n        Vue.axios(\r\n          \"http://novel.kele8.cn/book-chapters/\" + res.data[0]._id\r\n        ).then(res2 => {\r\n          // 因为第三次请求需要方法处理link字符串，所以这里直接使用next\r\n          next(vm => {\r\n            window.console.log(\"beforeRouteEnter的next开始执行\");\r\n            // 2.1 保存第二次请求的章节列表\r\n            vm.zhangjielist = res2.data.chapters;\r\n\r\n            // 2.2 判断页码是否存在，不存在则默认从第一章开始阅读\r\n            if (to.query.index) {\r\n              vm.index = to.query.index - 1;\r\n            } else {\r\n              vm.index = 0;\r\n            }\r\n            vm.startloading = false;\r\n\r\n            Vue.axios\r\n              .get(\"http://novel.kele8.cn/book-info/\" + to.query.id)\r\n              .then(res3 => {\r\n                vm.info = res3.data;\r\n              });\r\n          });\r\n        });\r\n      })\r\n  },\r\n  beforeRouteLeave(to, from, next) {\r\n    // 在这里可以进行保存本次阅读记录，保存到本地\r\n    // 获取本地对象\r\n    // var bookrack = localStorage.getItem('bookrack');\r\n    // if(bookrack){\r\n    //   bookrack.yuedujilu.push({\r\n    //     book:{\r\n    //      name:\r\n    // }\r\n    //     endTime: new Date()\r\n    //   })\r\n    // }\r\n    next();\r\n  },\r\n  created() {\r\n    window.console.log(\"阅读组件已创建\");\r\n  }\r\n};\r\n</script>\r\n\r\n<style lang='less' spcode>\r\n.cataloguejiemian {\r\n  width: 80%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: -100%;\r\n  transition: all 0.3s ease;\r\n  &.show {\r\n    left: 0px;\r\n  }\r\n}\r\n.showControl {\r\n  .top {\r\n    top: 0;\r\n  }\r\n  .bottom {\r\n    bottom: 0;\r\n  }\r\n}\r\n\r\n.top,\r\n.bottom {\r\n  transition: all 0.3s ease;\r\n}\r\n\r\n.top {\r\n  width: 100%;\r\n  position: fixed;\r\n  top: -150px;\r\n}\r\n\r\n.bottom {\r\n  width: 100%;\r\n  position: fixed;\r\n  bottom: -500px;\r\n}\r\n\r\n.yuedubook {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #eee6dd;\r\n\r\n  padding-top: 0.66667rem;\r\n  text-align: left;\r\n\r\n  &.night {\r\n    background-color: #0c0c0c;\r\n    h2 {\r\n      color: #888;\r\n    }\r\n    .yuedubook-box {\r\n      p {\r\n        color: #666;\r\n      }\r\n    }\r\n  }\r\n\r\n  &.eyeshield {\r\n    background-color: #b8cd8d;\r\n    h2 {\r\n      color: #0c2e10;\r\n    }\r\n    .yuedubook-box {\r\n      p {\r\n        color: rgba(12, 46, 16, 0.8);\r\n      }\r\n    }\r\n  }\r\n\r\n  h2 {\r\n    margin: 0px;\r\n    color: #333;\r\n    padding: 0 0.53333rem;\r\n    line-height: 1.5;\r\n\r\n    font-size: 24px;\r\n  }\r\n\r\n  .yuedubook-box {\r\n    color: #333;\r\n    padding: 0.26667rem 0.53333rem 0;\r\n\r\n    p {\r\n      color: #5c5d58;\r\n      // text-indent: 2em;\r\n      text-indent: 1cm;\r\n\r\n      line-height: 1.5;\r\n      margin: 0.3333rem 0;\r\n    }\r\n  }\r\n\r\n  .erweima {\r\n    width: 100%;\r\n    height: 100px;\r\n  }\r\n}\r\n</style>"]}]}